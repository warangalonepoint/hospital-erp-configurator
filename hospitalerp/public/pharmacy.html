<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Inventory & Pharmacy</title>
<link rel="icon" href="./assets/logo.png">
<style>
  :root{ --prim: #0ea5e9; --bg:#0b0b10; --card:#14141d; --mut:#a1a1aa; --ok:#16a34a; --warn:#eab308; --bad:#ef4444; }
  *{ box-sizing:border-box; } body{ margin:0; font-family:system-ui,Segoe UI,Roboto; background:var(--bg); color:#fff; }
  header{ position:sticky; top:0; background:#0d0d13; border-bottom:1px solid #1f1f29; padding:12px 16px; display:flex; gap:12px; align-items:center; z-index:5}
  header h1{ font-size:16px; margin:0; flex:1 }
  header .brand{ color:var(--mut); font-size:12px }
  .btn{ background:var(--card); border:1px solid #2a2a36; padding:8px 12px; border-radius:10px; color:#fff; cursor:pointer }
  .btn.primary{ background:var(--prim); border-color:transparent; color:#001019; font-weight:600 }
  .btn.ghost{ background:transparent; border-color:#2a2a36 }
  .wrap{ padding:16px }
  .tools{ display:flex; gap:8px; flex-wrap:wrap; margin-bottom:12px }
  .search{ flex:1; min-width:180px }
  input,select{ width:100%; padding:10px 12px; background:#0f0f16; color:#fff; border:1px solid #2a2a36; border-radius:10px }
  table{ width:100%; border-collapse:collapse; background:var(--card); border-radius:14px; overflow:hidden }
  th,td{ padding:12px; border-bottom:1px solid #1f1f29; text-align:left; font-size:14px }
  tr:last-child td{ border-bottom:none }
  .pill{ padding:2px 8px; border-radius:999px; font-size:12px; }
  .pill.low{ background:#241313; color:#ff7a7a; border:1px solid #3a1d1d }
  .pill.near{ background:#2a260d; color:#f6d26a; border:1px solid #3b3312 }
  .empty{ padding:40px; text-align:center; color:var(--mut) }
  .grid{ display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:10px }
  @media (min-width:900px){ .grid{ grid-template-columns:repeat(4,minmax(0,1fr)); } }
  .badge{ font-size:11px; color:#111; background:#a5f3fc; padding:2px 6px; border-radius:999px; }
</style>
</head>
<body>
<header>
  <div>
    <div class="brand" id="clinicTop">Clinic</div>
    <h1>Inventory & Pharmacy <span class="badge">Basic</span></h1>
  </div>
  <button class="btn" onclick="location.href='inventory-grn.html'+location.search">‚ûï GRN</button>
  <button class="btn ghost" id="exportCsvBtn">‚¨áÔ∏è CSV</button>
  <button class="btn" id="scanBtn">üì∑ Scan</button>
</header>

<div class="wrap">
  <div class="tools">
    <div class="search"><input id="q" placeholder="Search item or barcode‚Ä¶"/></div>
    <button class="btn primary" id="addItemBtn">Add Item</button>
    <button class="btn" id="alertsBtn">Alerts</button>
  </div>
  <div id="tableWrap"></div>
</div>

<!-- Add Item Modal -->
<dialog id="itemDlg">
  <form method="dialog" id="itemForm" style="background:#0c0c12;color:#fff;border:1px solid #2a2a36;border-radius:14px;padding:16px;min-width:320px">
    <h3 style="margin:0 0 12px">New Item</h3>
    <div class="grid">
      <div><label>Name<input name="name" required></label></div>
      <div><label>HSN<input name="hsn"></label></div>
      <div><label>Unit<input name="unit"></label></div>
      <div><label>Tax %<input name="tax" type="number" value="0"></label></div>
      <div><label>MRP<input name="mrp" type="number" step="0.01"></label></div>
      <div><label>Buy Price<input name="buyPrice" type="number" step="0.01"></label></div>
      <div><label>Barcode<input name="barcode" placeholder="optional"></label></div>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
      <button class="btn ghost" value="cancel">Cancel</button>
      <button class="btn primary">Save</button>
    </div>
  </form>
</dialog>

<script src="./js/inventory.js"></script>
<script src="./js/scanner.js"></script>
<script>
const api = window.InventoryAPI;
document.getElementById("clinicTop").textContent = window.erp?.branding?.clinicName || "Clinic";

// render table
async function render(){
  await api.openDB();
  const rows = await api.stockSnapshot();
  const q = (document.getElementById("q").value||"").toLowerCase();
  const filtered = rows.filter(r => r.item.name.toLowerCase().includes(q) || (r.item.barcode||"").includes(q));
  const tbl = document.createElement("table");
  tbl.innerHTML = `<thead><tr><th>Item</th><th>MRP</th><th>Qty</th><th>Batches</th><th>Flags</th><th></th></tr></thead>
  <tbody>${filtered.map(r=>`
    <tr>
      <td><b>${r.item.name}</b><div style="color:#a1a1aa;font-size:12px">HSN ${r.item.hsn||"-"} ‚Ä¢ ${r.item.unit||"-"}</div></td>
      <td>‚Çπ${Number(r.item.mrp||0).toFixed(2)}</td>
      <td>${r.qty}</td>
      <td>${r.batches.map(b=>`${b.batchNo} (${b.qty}) exp ${b.expiry}`).join(", ")||"-"}</td>
      <td>${r.low?'<span class="pill low">Low</span>':''}${r.nearCount?'<span class="pill near">Near Exp.</span>':''}</td>
      <td><button class="btn" onclick='printLabel(${r.item.id})'>Label</button></td>
    </tr>`).join("") || `<tr><td colspan=6 class="empty">No items yet.</td></tr>`}
  </tbody>`;
  document.getElementById("tableWrap").innerHTML=""; document.getElementById("tableWrap").appendChild(tbl);
}
async function printLabel(id){ const item=await api.getItem(id); api.printShelfLabel(item); }

// add item
const dlg=document.getElementById("itemDlg");
document.getElementById("addItemBtn").onclick=()=>dlg.showModal();
document.getElementById("itemForm").onsubmit=async e=>{
  e.preventDefault();
  const f=new FormData(e.target);
  await api.addItem({name:f.get("name"),hsn:f.get("hsn"),unit:f.get("unit"),tax:Number(f.get("tax")),mrp:Number(f.get("mrp")),buyPrice:Number(f.get("buyPrice")),barcode:f.get("barcode")});
  dlg.close(); e.target.reset(); render();
};

// alerts + export
document.getElementById("alertsBtn").onclick=async ()=>{
  const rows=await api.stockSnapshot();
  alert(`Low stock:\n${rows.filter(r=>r.low).map(r=>r.item.name).join(", ")||"None"}\n\nNear expiry:\n${rows.filter(r=>r.nearCount).map(r=>r.item.name).join(", ")||"None"}`);
};
document.getElementById("exportCsvBtn").onclick=async ()=>{
  const rows=await api.stockSnapshot(); api.download("inventory.csv", api.toCSV(rows));
};

// scan mode
document.getElementById("scanBtn").onclick=()=>{
  const s=new CameraScanner({onDetect:async code=>{
    document.getElementById("q").value=code; await render();
    const rows=await api.stockSnapshot();
    if(!rows.find(r=>(r.item.barcode||"")==code)){
      if(confirm(`Barcode ${code} not found. Create new item?`)){
        dlg.showModal();
        document.querySelector('#itemForm [name=barcode]').value=code;
      }
    }
  }}); s.open();
};

render(); document.getElementById("q").focus();
</script>
</body>
</html>
